# **Robo-Creator 后端架构与开发指南**

# **(Backend Architecture & Development Guide)**

**版本**：3.4 (i18n & AI-Ready Edition)

**日期**：2026-02

**适用对象**：AI 辅助开发者 (Cursor/Gemini)

**核心变更**：数据库字段支持多语言 (JSONB)，预留 AI Server Actions 接口，保持逻辑引擎的物理严谨性。

## **1\. 核心架构哲学 (Core Philosophy)**

1. **Monolithic Serverless**：  
   * 后端逻辑即前端项目中的 **Server Actions** (src/actions/\*)。  
   * **零运维**：不维护独立的 API 服务，所有逻辑运行在 Vercel Edge/Node Runtime。  
2. **i18n-First Data (国际化数据架构)**：  
   * **静态资产**：组件库的名称、描述等字段，数据库层面直接存储为 JSON ({"zh": "...", "en": "..."})，而非建立复杂的关联表。  
   * **动态内容**：用户的输入（如项目备注）通常跟随项目语言，暂存为字符串。  
3. **Strict Validator (物理铁律)**：  
   * 无论语言如何切换，物理校验逻辑（功率、载重）是通用的数学真理，后端逻辑引擎保持 **语言无关性**。

## **2\. 技术栈清单 (The Stack)**

| 模块 | 选型 | 说明 |
| :---- | :---- | :---- |
| **Runtime** | **Node.js** | Next.js Server Actions 运行环境。 |
| **Framework** | **Next.js 14+** | App Router。 |
| **Database** | **Supabase** | PostgreSQL，利用 JSONB 存储 i18n 数据和设计树。 |
| **ORM** | **Prisma** | 类型安全数据库操作。 |
| **Auth** | **Clerk** | 身份验证与多租户隔离。 |
| **AI** | **Vercel AI SDK** | **(新增)** 预留给二期 Text-to-Robot 的后端调用库。 |
| **Validation** | **Zod** | API 输入输出校验。 |

## **3\. 数据库设计 (Prisma Schema)**

**关键变更**：Component 表的 name 和 description 改为 Json 类型以支持多语言。

请复制以下代码至 prisma/schema.prisma。

generator client {  
  provider \= "prisma-client-js"  
}

datasource db {  
  provider  \= "postgresql"  
  url       \= env("DATABASE\_URL")  
  directUrl \= env("DIRECT\_URL")  
}

// \--------------------------------------  
// 1\. 用户 (User)  
// \--------------------------------------  
model User {  
  id             String    @id // Clerk User ID  
  email          String    @unique  
  firstName      String?  
  lastName       String?  
    
  role           UserRole  @default(USER)

  // 商业化字段  
  stripeCustomerId   String?  
  subscriptionStatus String?   
    
  projects       Project\[\]  
  createdAt      DateTime  @default(now())  
  updatedAt      DateTime  @updatedAt  
}

enum UserRole {  
  USER  
  ADMIN  
}

// \--------------------------------------  
// 2\. 组件库 (Component) \- i18n Ready  
// \--------------------------------------  
model Component {  
  id          String   @id @default(uuid())  
  sku         String   @unique  
  category    Category   
    
  // \--- 国际化字段 \---  
  // 存储结构: { "zh": "激光雷达", "en": "LiDAR" }  
  name        Json       
  description Json?  
    
  // \--- 物理参数 \---  
  specs       Json       
    
  modelRef    String   // GLB ID  
  thumbnail   String?  
  priceList   Decimal  @db.Decimal(10, 2\)  
    
  isActive    Boolean  @default(true)  
  createdAt   DateTime @default(now())  
  updatedAt   DateTime @updatedAt

  @@index(\[category\])  
}

enum Category {  
  CHASSIS  
  SENSOR  
  ACTUATOR  
  BATTERY  
  COMPUTE  
  ACCESSORY  
}

// \--------------------------------------  
// 3\. 项目 (Project)  
// \--------------------------------------  
model Project {  
  id          String   @id @default(uuid())  
  userId      String  
  user        User     @relation(fields: \[userId\], references: \[id\], onDelete: Cascade)  
    
  name        String  
  status      ProjectStatus @default(DRAFT)  
    
  // ODD 场景定义  
  requirements Json?   
    
  // 3D 设计树  
  designData   Json  
    
  // 校验状态  
  isValid      Boolean  @default(false)  
    
  // 备注与分析 (AI 生成内容或用户输入)  
  analysisNotes String? @db.Text  
  roiData       Json?      
  snapshotUrl   String?  
    
  createdAt     DateTime @default(now())  
  updatedAt     DateTime @updatedAt

  @@index(\[userId\])  
}

enum ProjectStatus {  
  DRAFT  
  DELIVERED  
  ARCHIVED  
}

## **4\. Server Actions 设计**

目录结构调整，增加 ai.ts 预留位：

src/  
├── actions/  
│   ├── project.ts        // 增删改查  
│   ├── catalog.ts        // 组件库查询 (处理 i18n)  
│   ├── validation.ts     // 物理校验引擎  
│   ├── export.ts         // 数据聚合  
│   └── ai.ts             // (二期预留) AI 生成逻辑

### **4.1 组件查询与国际化 (catalog.ts)**

后端不负责翻译，直接把 JSON 扔给前端。

**Prompt for AI**:

"编写 getComponents action。

1. 查询所有 isActive: true 的组件。  
2. 返回的数据中，name 和 description 保持原始 JSON 格式，由前端根据 Locale 进行渲染。  
3. priceList 转换为 number 类型。"

### **4.2 物理校验引擎 (validation.ts)**

保持严格的物理校验，**不受语言影响**。

**Prompt for AI**:

"编写 validateDesign 纯函数。

1. 输入：designData, requirements。  
2. 逻辑：  
   * 载重校验：totalWeight \<= maxPayload  
   * 功率校验：totalPower \<= maxOutput  
   * 爬坡校验：climbAngle \>= slope  
3. 输出：  
   * errors: string\[\] (错误信息建议返回 **错误代码** 如 ERR\_OVERWEIGHT，由前端翻译成对应语言)。"

### **4.3 AI 生成预留 (ai.ts)**

为二期功能占位。

'use server';

// 二期功能：Text-to-Robot  
export async function generateRobotFromText(prompt: string) {  
  // TODO: 集成 Vercel AI SDK \+ Gemini  
  // 1\. 检索组件库 (RAG)  
  // 2\. 生成 designData JSON  
  throw new Error("AI generation coming in Phase 2");  
}

## **5\. 类型契约 (Type Contracts)**

### **5.1 组件规格 (src/types/specs.ts)**

(保持不变，物理参数是通用的)

export interface BaseSpecs {  
  weight: number;  
}  
export interface BatterySpecs extends BaseSpecs {  
  maxOutput: number;  
  capacity: number;  
  voltage: number;  
}  
// ... ChassisSpecs, SensorSpecs  
export type ComponentSpecs \= BatterySpecs | any;

### **5.2 国际化数据类型 (src/types/i18n.ts)**

新增类型定义，方便前端处理。

export type LocalizedString \= {  
  \[key: string\]: string; // "en": "...", "zh": "..."  
};

export interface ComponentData {  
  id: string;  
  name: LocalizedString; // 变更点  
  description?: LocalizedString;  
  specs: ComponentSpecs;  
  // ...  
}

## **6\. 开发工作流 (AI Workflow)**

作为架构师，请按此顺序指挥 AI：

1. **Stage 1: 数据库迁移**  
   * 修改 schema.prisma 将 name 改为 Json。  
   * 运行 npx prisma db push。  
   * **注意**：这会清除旧数据（如果有），因为类型不兼容。  
2. **Stage 2: 种子数据注入**  
   * 更新 prisma/seed.ts，录入双语数据：  
     name: { zh: "高性能电池", en: "High Perf Battery" }

3. **Stage 3: 适配 Actions**  
   * 更新 validation.ts，确保返回的是错误代码 (Error Codes) 而不是硬编码的中文，方便前端做 i18n。  
4. **Stage 4: AI 接口预留**  
   * 创建 src/actions/ai.ts 文件，写好空函数，防止后续加功能时破坏结构。

这份文档确保了后端能够支撑前端的 **国际化显示** 和 **未来 AI 的结构化生成** 需求，同时维持了核心业务逻辑的纯净和严谨。