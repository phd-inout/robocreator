# **Robo-Creator 数据库架构设计说明书**

# **(Database Architecture Design Document)**

**版本**：2.2 (Final Type-Safe Edition)

**日期**：2026-02

**核心技术**：PostgreSQL (Supabase) \+ Prisma ORM \+ JSONB

**适用对象**：全栈开发者、AI 辅助编程上下文

## **1\. 核心设计哲学 (Core Philosophy)**

1. **Schema-First (契约优先)**：所有业务逻辑始于 schema.prisma。  
2. **Hybrid Storage (混合存储)**：  
   * **关系型 (SQL)**：用于身份、权限、订单、组件基础信息（SKU, 价格）。  
   * **文档型 (NoSQL)**：用于千变万化的组件物理参数 (specs) 和复杂的 3D 场景树 (designData)。  
3. **Type Safety (类型安全)**：虽然数据库层面是 JSON，但在应用层必须通过 **Zod Schema** 和 **TypeScript Interface** 强制约束 JSON 结构，防止逻辑引擎计算出错。

## **2\. 实体关系图 (ERD) & Prisma Schema**

请将以下代码完整复制到项目的 prisma/schema.prisma 文件中。

// \--------------------------------------------------------  
// 1\. 配置与生成器  
// \--------------------------------------------------------

generator client {  
  provider \= "prisma-client-js"  
}

datasource db {  
  provider  \= "postgresql"  
  url       \= env("DATABASE\_URL")  
  directUrl \= env("DIRECT\_URL") // Supabase 连接池优化  
}

// \--------------------------------------------------------  
// 2\. 用户与权限 (Identity)  
// \--------------------------------------------------------

model User {  
  // 使用 Clerk User ID 作为主键 (String)  
  id             String    @id  
  email          String    @unique  
  firstName      String?  
  lastName       String?  
  avatarUrl      String?

  // 角色：USER (普通), EXPERT (专家-您), ADMIN  
  role           UserRole  @default(USER)

  // 商业化 (Stripe)  
  stripeCustomerId       String?   @unique  
  subscriptionStatus     String?   // "active", "trialing", "past\_due"  
    
  projects       Project\[\]  
    
  createdAt      DateTime  @default(now())  
  updatedAt      DateTime  @updatedAt

  @@index(\[email\])  
}

enum UserRole {  
  USER  
  EXPERT  
  ADMIN  
}

// \--------------------------------------------------------  
// 3\. 组件库 (Catalog Asset) —— 核心资产  
// \--------------------------------------------------------

model Component {  
  id          String    @id @default(uuid())  
  sku         String    @unique  // 业务唯一货号，如 "LIDAR-VLP16"  
  name        String  
  category    Category

  // \--- 核心物理/技术参数 (JSONB) \---  
  // ⚠️ 警告：写入此字段前必须通过 Zod 校验  
  // 对应类型定义：src/types/specs.ts \-\> ComponentSpecs  
  specs       Json      

  // \--- 3D 可视化资源 \---  
  modelRef    String    // 关联的前端 GLB 模型ID (如 "generic\_lidar")  
  thumbnail   String?   // 缩略图 URL  
    
  // \--- 价格体系 \---  
  // MVP 阶段仅维护统一市场指导价  
  priceList   Decimal   @db.Decimal(10, 2\) 

  isActive    Boolean   @default(true) 

  createdAt   DateTime  @default(now())  
  updatedAt   DateTime  @updatedAt

  // 性能优化：为 JSONB 内部常用字段建立 GIN 索引 (需手动 SQL 执行)  
  // CREATE INDEX idx\_component\_specs ON "Component" USING GIN (specs);  
  @@index(\[category\])  
}

enum Category {  
  CHASSIS     // 底盘 (核心)  
  SENSOR      // 传感器 (雷达/相机/GPS)  
  ACTUATOR    // 执行器 (机械臂/升降杆)  
  BATTERY     // 能源  
  COMPUTE     // 算力/工控机  
  ACCESSORY   // 辅材  
}

// \--------------------------------------------------------  
// 4\. 项目与设计 (Business Logic)  
// \--------------------------------------------------------

model Project {  
  id          String    @id @default(uuid())  
  userId      String  
  user        User      @relation(fields: \[userId\], references: \[id\], onDelete: Cascade)

  name        String  
  description String?  
  status      ProjectStatus @default(DRAFT)

  // \--- 场景定义 (ODD) \---  
  // 结构: { "env": "outdoor", "slope": 15, "ground": "asphalt" }  
  requirements Json?

  // \--- 设计数据树 (The Design Tree) \---  
  // 结构: { "parts": Record\<string, Part\>, "meta": {...} }  
  // 直接对应前端 Zustand Store，无需转换  
  designData   Json

  // \--- 专家咨询增值模块 \---  
  expertNotes  String?   @db.Text // 专家手写建议  
  roiData      Json?     // ROI 计算结果 { "paybackMonths": 14 }  
  snapshotUrl  String?   // 3D 封面截图

  createdAt    DateTime  @default(now())  
  updatedAt    DateTime  @updatedAt

  @@index(\[userId\])  
}

enum ProjectStatus {  
  DRAFT  
  REVIEW      // 提交给专家评审  
  DELIVERED   // 报告已生成  
  ARCHIVED  
}

## **3\. JSONB 数据结构契约 (Implicit Schema)**

虽然数据库不强制校验 JSON 结构，但为了保证**逻辑引擎 (Logic Engine)** 能正确计算功率和负载，我们必须定义隐式契约。

**请在开发时，强制 AI 参考以下结构生成 TypeScript 接口。**

### **3.1 组件规格 (Component.specs)**

**通用字段 (Base)**:

{  
  "weight": 2.5,        // kg (浮点数)  
  "dims": \[0.5, 0.4, 0.2\], // m \[长, 宽, 高\]  
  "interface": "ETH"    // 接口类型  
}

**特定分类字段 (Category Specific)**:

* **底盘 (CHASSIS)**:  
  {  
    "max\_payload": 50,    // kg (最大载重) \- 逻辑引擎校验关键  
    "max\_speed": 1.5,     // m/s  
    "climb\_angle": 15     // degree  
  }

* **电池 (BATTERY)**:  
  {  
    "capacity": 200,      // Wh  
    "voltage": 24,        // V  
    "max\_output": 500     // W (最大放电功率) \- 逻辑引擎校验关键  
  }

* **传感器 (SENSOR)**:  
  {  
    "power": 8,           // W (功耗) \- 逻辑引擎校验关键  
    "range": 100,         // m  
    "fov\_v": 30           // degree  
  }

### **3.2 设计数据树 (Project.designData)**

这是前端 Zustand Store 的直接快照。

{  
  "meta": {  
    "total\_price": 15000,  
    "last\_edited": "2026-02-15T10:00:00Z"  
  },  
  "parts": {  
    "uuid-instance-1": {  
      "id": "uuid-instance-1",  
      "skuId": "CHASSIS-001",   // 关联 Component.sku  
      "parentId": null,         // 根节点  
      "position": \[0, 0, 0\],  
      "rotation": \[0, 0, 0\],  
      "socketId": null  
    },  
    "uuid-instance-2": {  
      "id": "uuid-instance-2",  
      "skuId": "LIDAR-16",  
      "parentId": "uuid-instance-1", // 父子关联  
      "position": \[0, 0.5, 0\],  
      "rotation": \[0, 0, 0\],  
      "socketId": "SOCKET\_TOP"       // 吸附点  
    }  
  }  
}

## **4\. 索引优化策略 (Indexing Strategy)**

为了应对未来可能的组件库膨胀（如 10,000+ SKU），我们需要利用 PostgreSQL 的 **GIN 索引** 来加速 JSONB 查询。

**场景**：用户筛选“所有载重 \> 50kg 的底盘”。

**SQL 优化建议** (在 Supabase SQL Editor 中执行)：

\-- 1\. 为 specs 字段创建 GIN 索引  
CREATE INDEX idx\_component\_specs ON "Component" USING GIN (specs);

\-- 2\. 为 category 创建常规索引 (Prisma 已自动处理 @@index)  
\-- 3\. 为 sku 创建唯一索引 (Prisma 已自动处理 @unique)

**查询示例 (Prisma 写法)**:

const chassis \= await prisma.component.findMany({  
  where: {  
    category: 'CHASSIS',  
    specs: {  
      path: \['max\_payload'\],  
      gte: 50 // 大于等于 50kg  
    }  
  }  
});

## **5\. 种子数据初始化 (Seed Strategy)**

请在 prisma/seed.ts 中使用以下模版初始化数据库，确保开发环境立即可用。

import { PrismaClient } from '@prisma/client'  
const prisma \= new PrismaClient()

async function main() {  
  // 1\. 初始化底盘  
  await prisma.component.upsert({  
    where: { sku: 'CHASSIS-GENERIC-01' },  
    update: {},  
    create: {  
      sku: 'CHASSIS-GENERIC-01',  
      name: '通用中型差速底盘',  
      category: 'CHASSIS',  
      priceList: 4500,  
      modelRef: 'generic\_chassis\_box',  
      specs: {  
        weight: 30,  
        dims: \[0.6, 0.5, 0.3\],  
        max\_payload: 80, // 逻辑引擎关键参数  
        max\_speed: 1.2  
      }  
    }  
  })

  // 2\. 初始化电池  
  await prisma.component.upsert({  
    where: { sku: 'BATTERY-24V-20AH' },  
    update: {},  
    create: {  
      sku: 'BATTERY-24V-20AH',  
      name: '24V 锂电池包',  
      category: 'BATTERY',  
      priceList: 1200,  
      modelRef: 'generic\_battery\_pack',  
      specs: {  
        weight: 3.5,  
        dims: \[0.2, 0.1, 0.1\],  
        voltage: 24,  
        capacity: 480,  
        max\_output: 500 // 逻辑引擎关键参数  
      }  
    }  
  })  
    
  console.log('✅ 数据库种子注入完成')  
}

main()  
  .then(async () \=\> { await prisma.$disconnect() })  
  .catch(async (e) \=\> { console.error(e); await prisma.$disconnect(); process.exit(1) })

这份文档不仅定义了数据库表结构，还明确了 JSON 内部的数据契约和索引策略，能够完美支撑后端逻辑引擎的计算需求，同时保持了极高的扩展性。